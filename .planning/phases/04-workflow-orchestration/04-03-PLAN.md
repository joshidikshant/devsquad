---
phase: 04-workflow-orchestration
plan: "03"
type: execute
wave: 3
depends_on:
  - "04-01"
  - "04-02"
autonomous: false
files_modified: []
requirements:
  - ORCH-01
  - ORCH-02
  - ORCH-03
  - ORCH-04

must_haves:
  truths:
    - "Dry-run mode prints all 4 steps from feature-workflow.json without executing them"
    - "The permission gate prompts before the destructive cleanup-staging step"
    - "A checkpoint commit is recorded after the generate-skill step"
    - "Post-workflow validation prints git health status and test result"
    - "Failed steps print rollback hints with git reset --hard and recorded checkpoint hashes"
  artifacts:
    - path: "plugin/skills/workflow-orchestration/scripts/run-workflow.sh"
      provides: "Verified working driver"
    - path: "plugin/skills/workflow-orchestration/scripts/lib-workflow.sh"
      provides: "Verified helper library"
    - path: "plugin/skills/workflow-orchestration/templates/feature-workflow.json"
      provides: "Verified workflow definition"
  key_links:
    - from: "run-workflow.sh --dry-run"
      to: "feature-workflow.json steps"
      via: "jq step iteration"
      pattern: "DRY RUN.*Would execute"
---

<objective>
Verify the complete workflow orchestration skill end-to-end via dry-run and interactive test.

Purpose: Human verification confirms that all four ORCH requirements work together as a coherent system â€” not just that individual functions exist. The dry-run check is automated; the interactive gate test requires user confirmation that the /dev/tty prompt appears correctly.

Output: Confirmed working workflow-orchestration skill ready for use.
</objective>

<execution_context>
@/Users/Dikshant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Dikshant/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-workflow-orchestration/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated dry-run verification</name>
  <files></files>
  <action>
Run the following verification commands and confirm each passes:

```bash
# 1. Syntax checks on all created scripts
bash -n plugin/skills/workflow-orchestration/scripts/lib-workflow.sh
bash -n plugin/skills/workflow-orchestration/scripts/run-workflow.sh

# 2. Dry-run with feature-workflow.json (should print all 4 steps, no execution)
bash plugin/skills/workflow-orchestration/scripts/run-workflow.sh \
  --dry-run \
  --workflow plugin/skills/workflow-orchestration/templates/feature-workflow.json

# 3. Verify JSON template validity
python3 -c "
import json
d = json.load(open('plugin/skills/workflow-orchestration/templates/feature-workflow.json'))
steps = d['steps']
assert len(steps) >= 2, f'Expected >= 2 steps, got {len(steps)}'
destructive = [s['id'] for s in steps if s.get('destructive')]
checkpoint = [s['id'] for s in steps if s.get('checkpoint')]
assert len(destructive) >= 1, f'Expected >= 1 destructive step, got {destructive}'
assert len(checkpoint) >= 1, f'Expected >= 1 checkpoint step, got {checkpoint}'
print(f'JSON valid: {len(steps)} steps, destructive={destructive}, checkpoint={checkpoint}')
"

# 4. Check DEVSQUAD_HOOK_DEPTH is exported
grep -n "export DEVSQUAD_HOOK_DEPTH" plugin/skills/workflow-orchestration/scripts/run-workflow.sh

# 5. Check rollback hint print is informational (no auto-execution)
# Must contain 'git reset --hard' as echo/string, not as a command call
grep -n "git reset --hard" plugin/skills/workflow-orchestration/scripts/run-workflow.sh

# 6. Confirm command stub wires correctly
grep "devsquad:workflow-orchestration" plugin/commands/workflow.md

# 7. Confirm --skip-gates flag exists
grep "skip-gates\|SKIP_GATES" plugin/skills/workflow-orchestration/scripts/run-workflow.sh
```

All 7 checks must pass without errors. If any fail, fix the issue before proceeding to the checkpoint task.
  </action>
  <verify>
    bash -n plugin/skills/workflow-orchestration/scripts/lib-workflow.sh && echo "lib-workflow.sh: OK"
    bash -n plugin/skills/workflow-orchestration/scripts/run-workflow.sh && echo "run-workflow.sh: OK"
    bash plugin/skills/workflow-orchestration/scripts/run-workflow.sh --dry-run --workflow plugin/skills/workflow-orchestration/templates/feature-workflow.json | grep -q "DRY RUN" && echo "dry-run: OK"
  </verify>
  <done>
    All 7 automated checks pass. Dry-run output shows all steps with "[DRY RUN]" prefix and no actual command execution occurs.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of workflow skill end-to-end</name>
  <files></files>
  <action>Verify the complete workflow-orchestration skill end-to-end using the steps in how-to-verify below.</action>
  <verify>bash plugin/skills/workflow-orchestration/scripts/run-workflow.sh --dry-run --workflow plugin/skills/workflow-orchestration/templates/feature-workflow.json | grep -q "DRY RUN"</verify>
  <done>Dry-run output shows all 4 steps with [DRY RUN] prefix. User confirms interactive gate and validation work correctly by typing "approved".</done>
  <what-built>
    Complete workflow-orchestration skill:
    - plugin/skills/workflow-orchestration/scripts/lib-workflow.sh (workflow_gate, workflow_checkpoint, workflow_validate)
    - plugin/skills/workflow-orchestration/scripts/run-workflow.sh (main driver with --dry-run, --skip-gates flags)
    - plugin/skills/workflow-orchestration/templates/feature-workflow.json (4-step example with destructive + checkpoint steps)
    - plugin/skills/workflow-orchestration/SKILL.md
    - plugin/commands/workflow.md (command stub)
  </what-built>
  <how-to-verify>
    1. Run the dry-run and confirm all 4 steps are printed (no commands executed):
       ```
       bash plugin/skills/workflow-orchestration/scripts/run-workflow.sh \
         --dry-run \
         --workflow plugin/skills/workflow-orchestration/templates/feature-workflow.json
       ```
       Expected output: "=== DevSquad Workflow Orchestration ===" followed by "[DRY RUN] Would execute:" for each step.

    2. Run with --skip-gates to verify end-to-end execution without prompts (safe to test in a clean repo):
       ```
       bash plugin/skills/workflow-orchestration/scripts/run-workflow.sh \
         --skip-gates \
         --workflow plugin/skills/workflow-orchestration/templates/feature-workflow.json
       ```
       Expected: Steps execute, checkpoint steps attempt git commit, validation runs at end.

    3. Confirm the command stub exists: `cat plugin/commands/workflow.md`

    4. Confirm the SKILL.md exists: `cat plugin/skills/workflow-orchestration/SKILL.md`
  </how-to-verify>
  <resume-signal>Type "approved" when verified, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
# Final file inventory
ls -la plugin/skills/workflow-orchestration/scripts/
ls -la plugin/skills/workflow-orchestration/templates/
ls -la plugin/commands/workflow.md
ls -la plugin/skills/workflow-orchestration/SKILL.md

# Final syntax check
bash -n plugin/skills/workflow-orchestration/scripts/lib-workflow.sh
bash -n plugin/skills/workflow-orchestration/scripts/run-workflow.sh
</verification>

<success_criteria>
- Dry-run prints all 4 steps from feature-workflow.json without executing any commands
- Human confirms the /dev/tty permission gate prompt works as expected in interactive mode
- Human confirms post-workflow validation section prints git health status
- All 5 files exist and are syntactically valid
- User types "approved"
</success_criteria>

<output>
After completion, create `.planning/phases/04-workflow-orchestration/04-03-SUMMARY.md` following the summary template at @/Users/Dikshant/.claude/get-shit-done/templates/summary.md
</output>
