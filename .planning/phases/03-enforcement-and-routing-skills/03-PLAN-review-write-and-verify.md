---
phase: 03-enforcement-and-routing-skills
plan: 03
type: execute
wave: 3
depends_on:
  - 03-01
  - 03-02
files_modified:
  - plugin/skills/code-generation/scripts/generate-skill.sh
autonomous: false
requirements:
  - CGEN-04
  - CGEN-05

must_haves:
  truths:
    - "Running generate-skill.sh with a real description prints the full draft and prompts [y/N/e]"
    - "Answering 'n' prints 'Aborted' and writes no files"
    - "Answering 'y' creates plugin/skills/<name>/SKILL.md, plugin/skills/<name>/scripts/<name>.sh, and plugin/commands/<name>.md"
    - "Answering 'e' re-runs the Codex draft with additional user-provided feedback"
    - "After writing, bash -n validation runs on generated scripts and reports pass/fail"
    - "The code-generation skill itself is invocable via /devsquad:generate (CGEN-05 self-referential)"
    - "--dry-run flag prints draft and skips all write operations"
  artifacts:
    - path: "plugin/skills/code-generation/scripts/generate-skill.sh"
      provides: "Complete script with review loop, file writing, and verification"
      contains: "read -r CONFIRM"
    - path: "plugin/skills/code-generation/scripts/generate-skill.sh"
      provides: "Draft parser splitting on === FILE: ... === delimiter"
      contains: "=== FILE:"
  key_links:
    - from: "plugin/skills/code-generation/scripts/generate-skill.sh"
      to: "plugin/skills/<generated-name>/"
      via: "write_state calls for each parsed file section"
      pattern: "write_state"
    - from: "plugin/skills/code-generation/scripts/generate-skill.sh"
      to: "plugin/commands/<generated-name>.md"
      via: "write_state for command stub section"
      pattern: "commands/"
---

<objective>
Replace the review/write stubs in generate-skill.sh with: interactive [y/N/e] review loop, draft parser that splits on "=== FILE: ... ===" delimiter, atomic file writing via write_state, bash -n validation of generated scripts, and a summary of files written. The --dry-run flag skips writing. CGEN-05 is satisfied by the skill's own existence and invocability via /devsquad:generate.

Purpose: Completes the full UX flow. After this plan, the skill is end-to-end functional: describe → research → draft → review → write → verify.
Output: Fully working generate-skill.sh. New skills generated by it are immediately invocable.
</objective>

<execution_context>
@/Users/Dikshant/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Dikshant/.claire/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-enforcement-and-routing-skills/03-02-SUMMARY.md
@plugin/skills/code-generation/scripts/generate-skill.sh
@plugin/lib/state.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement review loop, draft parser, and file writer</name>
  <files>plugin/skills/code-generation/scripts/generate-skill.sh</files>
  <action>
Replace the Phase 3 review stub block and everything after it. The stub is:

```bash
# STUB — confirmation and file writing implemented in Plan 03
echo "[dry-run or stub mode — Plan 03 will implement write phase]"
```

Replace it and everything after with the following complete implementation. This block goes after the DRAFT variable is populated:

```bash
# ---------------------------------------------------------------------------
# Phase 3: Review (interactive [y/N/e] loop)
# ---------------------------------------------------------------------------
echo "[3/4] Draft ready for review..."

EDIT_FEEDBACK=""
while true; do
  echo ""
  echo "========================================"
  echo "  GENERATED DRAFT"
  echo "========================================"
  echo "$DRAFT"
  echo "========================================"
  echo ""

  if [[ "$DRY_RUN" == "true" ]]; then
    echo "[dry-run] Skipping write phase. Files not written."
    exit 0
  fi

  read -r -p "Write these files? [y]es / [n]o / [e]dit prompt: " CONFIRM

  case "${CONFIRM,,}" in
    y|yes)
      break
      ;;
    n|no)
      echo "Aborted. No files written."
      exit 0
      ;;
    e|edit)
      read -r -p "Describe what to change in the draft: " EDIT_FEEDBACK
      echo ""
      echo "[2/4] Re-drafting with feedback: ${EDIT_FEEDBACK}"
      DRAFT=$(invoke_codex \
"Revise this DevSquad skill draft based on this feedback: ${EDIT_FEEDBACK}

Original description: ${DESCRIPTION}
Skill name: ${SKILL_NAME}

Current draft:
${DRAFT}

Use the same === FILE: <name> === delimiters. Output only the revised files, no other commentary." \
        0 \
        120)
      if [[ $? -ne 0 ]]; then
        echo "Error: Codex revision failed." >&2
        echo "$DRAFT" >&2
        exit 1
      fi
      ;;
    *)
      echo "Please enter y, n, or e."
      ;;
  esac
done

# ---------------------------------------------------------------------------
# Phase 4: Write (parse draft sections and write atomically)
# ---------------------------------------------------------------------------
echo "[4/4] Writing files..."

# Target skill directory (inside the plugin, parallel to existing skills)
SKILL_DIR="${PLUGIN_ROOT}/skills/${SKILL_NAME}"
SKILL_SCRIPTS_DIR="${SKILL_DIR}/scripts"

mkdir -p "${SKILL_SCRIPTS_DIR}"

# Parse draft into sections by "=== FILE: <name> ===" delimiter
# Strategy: iterate through draft line by line, accumulate content per section
CURRENT_FILE=""
CURRENT_CONTENT=""
WRITTEN_FILES=()

parse_and_write_draft() {
  local line
  while IFS= read -r line; do
    if [[ "$line" =~ ^===\ FILE:\ (.+)\ ===$ ]]; then
      # Write previous section if we have one
      if [[ -n "$CURRENT_FILE" && -n "$CURRENT_CONTENT" ]]; then
        _write_draft_file "$CURRENT_FILE" "$CURRENT_CONTENT"
      fi
      CURRENT_FILE="${BASH_REMATCH[1]}"
      CURRENT_CONTENT=""
    else
      CURRENT_CONTENT="${CURRENT_CONTENT}${line}
"
    fi
  done <<< "$DRAFT"

  # Write final section
  if [[ -n "$CURRENT_FILE" && -n "$CURRENT_CONTENT" ]]; then
    _write_draft_file "$CURRENT_FILE" "$CURRENT_CONTENT"
  fi
}

_write_draft_file() {
  local file_spec="$1"  # e.g. "SKILL.md" or "scripts/bulk-rename.sh" or "commands/bulk-rename.md"
  local content="$2"

  # Strip leading newline from content
  content="${content#$'\n'}"

  local dest_path
  if [[ "$file_spec" == "SKILL.md" ]]; then
    dest_path="${SKILL_DIR}/SKILL.md"
  elif [[ "$file_spec" == scripts/* ]]; then
    dest_path="${SKILL_DIR}/${file_spec}"
  elif [[ "$file_spec" == commands/* ]]; then
    dest_path="${PLUGIN_ROOT}/${file_spec}"
  else
    # Unknown section — write to skill dir root with warning
    echo "  Warning: Unknown file spec '${file_spec}', writing to skill dir root" >&2
    dest_path="${SKILL_DIR}/${file_spec}"
  fi

  local dest_dir
  dest_dir="$(dirname "$dest_path")"
  mkdir -p "$dest_dir"

  # Atomic write via write_state (tmp+rename pattern from state.sh)
  write_state "$dest_path" "$content"
  WRITTEN_FILES+=("$dest_path")
  echo "  Wrote: ${dest_path}"

  # Make shell scripts executable
  if [[ "$dest_path" == *.sh ]]; then
    chmod +x "$dest_path"
  fi
}

parse_and_write_draft

# Fallback: if delimiter parsing found nothing, write raw draft as single file with warning
if [[ ${#WRITTEN_FILES[@]} -eq 0 ]]; then
  echo ""
  echo "Warning: Draft did not contain expected === FILE: ... === delimiters." >&2
  echo "Writing raw draft to ${SKILL_DIR}/DRAFT.txt for manual review." >&2
  write_state "${SKILL_DIR}/DRAFT.txt" "$DRAFT"
  WRITTEN_FILES=("${SKILL_DIR}/DRAFT.txt")
fi

# ---------------------------------------------------------------------------
# Verification: bash -n on generated shell scripts
# ---------------------------------------------------------------------------
VALIDATION_PASSED=true
for f in "${WRITTEN_FILES[@]}"; do
  if [[ "$f" == *.sh ]]; then
    if bash -n "$f" 2>/dev/null; then
      echo "  [PASS] bash -n ${f}"
    else
      echo "  [FAIL] bash -n ${f} — syntax error in generated script" >&2
      VALIDATION_PASSED=false
    fi
  fi
done

# ---------------------------------------------------------------------------
# Summary
# ---------------------------------------------------------------------------
echo ""
echo "========================================"
echo "  GENERATION COMPLETE"
echo "========================================"
echo ""
echo "Skill name : ${SKILL_NAME}"
echo "Files      :"
for f in "${WRITTEN_FILES[@]}"; do
  echo "  - ${f}"
done
echo ""
if [[ "$VALIDATION_PASSED" == "true" ]]; then
  echo "Validation : PASSED (bash -n)"
else
  echo "Validation : FAILED — review generated scripts for syntax errors"
fi
echo ""
echo "To invoke the new skill:"
echo "  /devsquad:${SKILL_NAME}"
echo ""
```
  </action>
  <verify>bash -n plugin/skills/code-generation/scripts/generate-skill.sh && echo "syntax OK"
grep -q "read -r CONFIRM\|read -r -p" plugin/skills/code-generation/scripts/generate-skill.sh && echo "review prompt OK"
grep -q "write_state" plugin/skills/code-generation/scripts/generate-skill.sh && echo "write_state OK"
grep -q "=== FILE:" plugin/skills/code-generation/scripts/generate-skill.sh && echo "delimiter parser OK"
grep -q "dry-run\|DRY_RUN" plugin/skills/code-generation/scripts/generate-skill.sh && echo "dry-run OK"
bash plugin/skills/code-generation/scripts/generate-skill.sh --help 2>&1 | grep -q "Usage" && echo "help flag OK"</verify>
  <done>bash -n passes on the complete script. grep confirms read -r prompt, write_state, delimiter parsing, and DRY_RUN guard are all present. --help prints usage.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete generate-skill.sh: argument parsing, Gemini research, Codex draft with delimiter output, [y/N/e] review loop, draft parser, atomic file writing, bash -n validation, and summary. Command stub plugin/commands/generate.md wires /devsquad:generate to the skill.
  </what-built>
  <how-to-verify>
1. Syntax check: run `bash -n plugin/skills/code-generation/scripts/generate-skill.sh` — must print nothing and exit 0

2. Dry-run end-to-end test (no files written, but exercises full pipeline):
   ```bash
   cd /Users/Dikshant/Desktop/Projects/devsquad
   bash plugin/skills/code-generation/scripts/generate-skill.sh "check disk usage and alert when above threshold" --name disk-monitor --dry-run
   ```
   Expected: prints research progress, draft progress, shows full draft, then exits with "[dry-run] Skipping write phase."

3. Abort test (answer 'n' at prompt):
   ```bash
   bash plugin/skills/code-generation/scripts/generate-skill.sh "list running docker containers" --name docker-list
   ```
   At the prompt, type 'n'. Expected: "Aborted. No files written."

4. Full write test (answer 'y' at prompt):
   ```bash
   bash plugin/skills/code-generation/scripts/generate-skill.sh "show git log as a compact one-line tree" --name git-tree
   ```
   At the prompt, type 'y'. Expected: files created at plugin/skills/git-tree/ and plugin/commands/git-tree.md. Validation shows [PASS].

5. Verify /devsquad:generate command is registered:
   ```bash
   ls plugin/commands/ | grep generate
   ```
   Expected: generate.md appears.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe which steps failed and what output you saw.</resume-signal>
</task>

</tasks>

<verification>
1. bash -n plugin/skills/code-generation/scripts/generate-skill.sh exits 0
2. --dry-run exits after showing draft, no files written
3. 'n' at review prompt exits cleanly, no files written
4. 'y' at review prompt creates skill directory, scripts, and command stub
5. Generated .sh files pass bash -n validation (printed in summary)
6. plugin/commands/generate.md exists and contains "devsquad:code-generation"
7. CGEN-05: /devsquad:generate is invocable (command stub present + skill directory present)
</verification>

<success_criteria>
- Full generate-skill.sh pipeline works end-to-end: description in → skill files out
- Review loop offers [y]es / [n]o / [e]dit choices and handles each correctly
- Draft parser splits on "=== FILE: ... ===" and writes each section to the correct path
- Generated skills land in plugin/skills/<name>/ and command stubs in plugin/commands/<name>.md
- bash -n validation runs automatically on generated shell scripts
- --dry-run exercises full pipeline without writing
- CGEN-04 satisfied: draft presented for user review/iteration before writing
- CGEN-05 satisfied: code-generation skill is itself a DevSquad skill invocable via /devsquad:generate, demonstrating self-referential skill generation capability
</success_criteria>

<output>
After completion, create .planning/phases/03-enforcement-and-routing-skills/03-03-SUMMARY.md with:
- Files modified (1 file — generate-skill.sh)
- Review loop design ([y/N/e] with edit re-run)
- Draft parser implementation (line-by-line BASH_REMATCH on delimiter)
- Fallback behavior when delimiters not found
- CGEN-05 satisfaction explanation
- Checkpoint results from human verification
</output>
